# name: test/sql/pac_bitslice_compiler_no_pk.test
# description: Test bitslice compiler queries without primary keys (various SUM/COUNT patterns)
# group: [sql]

require pac

statement ok
PRAGMA clear_pac_metadata;

statement ok
SET pac_seed = 42

statement ok
SET threads = 1

statement ok
SET pac_mi = 0

statement ok
SET pac_deterministic_noise = true

# Create two tables with 25 rows each and 5 groups (grp = i % 5)
statement ok
CREATE TABLE bitslice_a AS
SELECT i AS id, i % 5 AS grp, (i % 10) AS val, (i % 3) AS grp2
FROM range(25) t(i)

statement ok
CREATE TABLE bitslice_b AS
SELECT i AS id, i % 5 AS grp, ((i * 2) % 10) AS val_b, (i % 4) AS other
FROM range(25) t(i)

statement ok
ALTER TABLE bitslice_a SET PU;

# Ungrouped SUM / COUNT on a single table
query I
SELECT SUM(val) FROM bitslice_a
----
84

query I
SELECT COUNT(val) AS c FROM bitslice_a
----
26

# SUM with JOIN (no GROUP BY)
query I
SELECT SUM(a.val)
FROM bitslice_a a JOIN bitslice_b b ON a.grp = b.grp
----
420

# COUNT with JOIN + GROUP BY
query II
SELECT b.other, COUNT(a.id)
FROM bitslice_a a INNER JOIN bitslice_b b ON a.grp = b.grp
GROUP BY b.other
ORDER BY b.other
LIMIT 1
----
0	42

# ========== LEFT JOIN TEST CASES ==========

# Test LEFT JOIN with no-PK table on left
query II
SELECT b.other, COUNT(*)
FROM bitslice_a a
LEFT JOIN bitslice_b b ON a.grp = b.grp
GROUP BY b.other
ORDER BY b.other
LIMIT 1
----
0	42

# Test LEFT JOIN with NULL handling (no PK)
statement ok
INSERT INTO bitslice_a VALUES (100, 5, 99, 0);

query II
SELECT b.other, SUM(a.val)
FROM bitslice_a a
LEFT JOIN bitslice_b b ON a.grp = b.grp
WHERE b.other IS NOT NULL
GROUP BY b.other
ORDER BY b.other
LIMIT 1
----
0	136

statement ok
DELETE FROM bitslice_a WHERE id = 100;

# Edge case: table that actually has a column named "rowid"
statement ok
CREATE TABLE bitslice_with_rowid AS
SELECT i AS rowid, i % 5 AS grp, (i % 10) AS val
FROM range(10) t(i)

statement ok
ALTER TABLE bitslice_with_rowid SET PU;

query I
SELECT SUM(val) FROM bitslice_with_rowid
----
44

query I
SELECT COUNT(rowid) FROM bitslice_with_rowid
----
14

# Test RIGHT JOIN with no-PK tables, aggregating with filtering condition
query III
SELECT b.other, COUNT(*), SUM(COALESCE(a.val, 0))
FROM bitslice_a a
RIGHT JOIN bitslice_b b ON a.grp = b.grp AND a.grp2 = 0
GROUP BY b.other
ORDER BY b.other
LIMIT 1
----
0	10	22

# Cleanup
statement ok
DROP TABLE bitslice_a

statement ok
DROP TABLE bitslice_b

statement ok
DROP TABLE bitslice_with_rowid
