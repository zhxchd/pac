# name: test/sql/pac_compatible.test
# description: test the PAC (Privacy-Aware Compilation) extension via PAC pragmas
# group: [sql]

require pac

# Start fresh by clearing any existing PAC metadata
statement ok
PRAGMA clear_pac_metadata;

statement ok
SET pac_seed = 42

statement ok
SET pac_deterministic_noise = true

statement ok
SET threads = 1

statement ok
SET pac_mi = 0

# Create a test table
statement ok
CREATE TABLE t1(a INTEGER, b INTEGER);

statement ok
INSERT INTO t1 VALUES (1, 10), (2, 20), (3, 30), (3 , 40);

# Mark table as PAC privacy unit using ALTER TABLE SET PAC
statement ok
ALTER TABLE t1 SET PU;

# PAC-compatible query: SUM
query I
SELECT SUM(b) FROM t1;
----
160

# PAC-compatible query: COUNT
query I
SELECT COUNT(*) FROM t1;
----
6

# PAC-compatible query: AVG
query I
SELECT AVG(b) FROM t1;
----
40.0

# Not PAC-compatible: GROUP BY on PU column (even with aggregate, the GROUP BY itself is not allowed)
statement error
SELECT a, SUM(b) FROM t1 GROUP BY a ORDER BY a;
----
PAC rewrite: columns from privacy unit tables can only be accessed inside aggregate functions (e.g., SUM, COUNT, AVG, MIN, MAX)

# PAC-compatible query: INNER JOIN
statement ok
CREATE TABLE t2(x INTEGER, y INTEGER);

statement ok
INSERT INTO t2 VALUES (1, 100), (2, 200);

# Not PAC-compatible: GROUP BY on PU column in join
statement error
SELECT t1.a, SUM(t2.y) FROM t1 INNER JOIN t2 ON t1.a = t2.x GROUP BY t1.a ORDER BY t1.a;
----
PAC rewrite: columns from privacy unit tables can only be accessed inside aggregate functions (e.g., SUM, COUNT, AVG, MIN, MAX)

# PAC-compatible: not a PAC query (table not in privacy file)
query II
SELECT * FROM t2;
----
1	100
2	200

# Not PAC-compatible: no aggregate
statement error
SELECT a FROM t1;
----
Invalid Input Error: Query does not contain any allowed aggregation (sum, count, avg, min, max)!

# PAC-compatible: MIN
query I
SELECT MIN(a) FROM t1;
----
1

# PAC-compatible: multiple joins with non-PU GROUP BY
statement ok
CREATE TABLE t3(m INTEGER, n INTEGER);

statement ok
INSERT INTO t3 VALUES (1, 1000), (2, 2000);

# Not PAC-compatible: GROUP BY on PU column even in multi-table join
statement error
SELECT t1.a, SUM(t3.n) FROM t1 INNER JOIN t2 ON t1.a = t2.x INNER JOIN t3 ON t2.x = t3.m GROUP BY t1.a ORDER BY t1.a;
----
PAC rewrite: columns from privacy unit tables can only be accessed inside aggregate functions (e.g., SUM, COUNT, AVG, MIN, MAX)

# Not PAC-compatible: GROUP BY on non-PU column in multi-table join
statement error
SELECT t2.x, SUM(t3.n) FROM t1 INNER JOIN t2 ON t1.a = t2.x INNER JOIN t3 ON t2.x = t3.m GROUP BY t2.x ORDER BY t2.x;
----
PAC rewrite: columns from privacy unit tables can only be accessed inside aggregate functions (e.g., SUM, COUNT, AVG, MIN, MAX)

# Not PAC-compatible: projecting join key from non-PU table (exposes PU column value)
statement error
SELECT t2.x, SUM(t1.b) FROM t1 INNER JOIN t2 ON t1.a = t2.x GROUP BY t2.x ORDER BY t2.x;
----
PAC rewrite: columns from privacy unit tables can only be accessed inside aggregate functions (e.g., SUM, COUNT, AVG, MIN, MAX)

# PAC-compatible: projecting non-join key from non-PU table is OK
query II
SELECT t2.y, SUM(t1.b) FROM t1 INNER JOIN t2 ON t1.a = t2.x GROUP BY t2.y ORDER BY t2.y;
----
100	20
200	0

# Not PAC-compatible: projecting join key in LEFT JOIN (still exposes PU value)
statement error
SELECT t2.x, SUM(t1.b) FROM t1 LEFT JOIN t2 ON t1.a = t2.x GROUP BY t2.x ORDER BY t2.x;
----
PAC rewrite: columns from privacy unit tables can only be accessed inside aggregate functions (e.g., SUM, COUNT, AVG, MIN, MAX)

# PAC-compatible: LEFT JOIN with non-join key projection
# Not PAC-compatible: window function
statement error
SELECT a, SUM(b) OVER (PARTITION BY a) FROM t1;
----
PAC rewrite: window functions are not supported for PAC compilation

# Not PAC-compatible: direct column projection from PU table (no aggregate)
statement error
SELECT a FROM t1;
----
Query does not contain any allowed aggregation (sum, count, avg, min, max)!

# Not PAC-compatible: selecting PU column directly even with aggregate on another column
statement error
SELECT a, SUM(b) FROM t1 GROUP BY a;
----
PAC rewrite: columns from privacy unit tables can only be accessed inside aggregate functions (e.g., SUM, COUNT, AVG, MIN, MAX)

# PAC-compatible: PU column in WHERE clause (this IS allowed)
query I
SELECT SUM(b) FROM t1 WHERE a > 1;
----
140

# Test with joins: PU column cannot be projected directly
statement error
SELECT t1.a FROM t1 INNER JOIN t2 ON t1.a = t2.x;
----
Query does not contain any allowed aggregation (sum, count, avg, min, max)!

# Test with joins: PU column cannot be in GROUP BY
statement error
SELECT t1.a, SUM(t2.y) FROM t1 INNER JOIN t2 ON t1.a = t2.x GROUP BY t1.a;
----
Invalid Input Error: PAC rewrite: columns from privacy unit tables can only be accessed inside aggregate functions (e.g., SUM, COUNT, AVG, MIN, MAX)

# Test with joins: PU column cannot be projected even with non-PU group by
statement error
SELECT t1.a, t2.x, SUM(t1.b) FROM t1 INNER JOIN t2 ON t1.a = t2.x GROUP BY t1.a, t2.x;
----
PAC rewrite: columns from privacy unit tables can only be accessed inside aggregate functions (e.g., SUM, COUNT, AVG, MIN, MAX)

# Test expressions: PU column in arithmetic expression outside aggregate not allowed
statement error
SELECT a * 2 FROM t1;
----
Query does not contain any allowed aggregation (sum, count, avg, min, max)!

# Test expressions: PU column in arithmetic expression INSIDE aggregate is allowed
query I
SELECT SUM(a * 2) FROM t1;
----
28

# Test CASE expression: PU column in CASE outside aggregate not allowed
statement error
SELECT CASE WHEN a > 1 THEN 1 ELSE 0 END FROM t1;
----
Query does not contain any allowed aggregation (sum, count, avg, min, max)!

# Test CASE expression: PU column in CASE inside aggregate is allowed
query I
SELECT SUM(CASE WHEN a > 1 THEN b ELSE 0 END) FROM t1;
----
140

# TODO: Self-join tests below currently succeed but should be rejected once
# stricter join checking between sensitive tables is implemented.
# The self-join detection was disabled/broken - these tests document current behavior.

# Test self-join: currently succeeds (should be rejected in future)
query I
SELECT SUM(t1a.b + t1b.b) FROM t1 t1a JOIN t1 t1b ON t1a.a = t1b.a;
----
600

# Test self-join inside subquery: currently crashes due to categorical rewriter issue
# TODO: Fix crash and either reject self-joins or handle them correctly
# Disabled for now:
# statement error
# SELECT SUM(b) FROM t1 WHERE a > (SELECT SUM(t1a.b) FROM t1 t1a JOIN t1 t1b ON t1a.a = t1b.a);
# ----
# PAC rewrite: self-joins are not supported for PAC compilation

# Test same table in main query and subquery (different scopes): should PASS
query I
SELECT SUM(b) FROM t1 WHERE a > (SELECT AVG(b) FROM t1);
----
NULL

# Test conservative mode OFF: subquery should execute normally (no error)
statement ok
SET pac_conservative_mode = false;

# Window function should succeed when conservative mode is off
query I
SELECT SUM(window_sum) FROM (SELECT a, SUM(b) OVER (PARTITION BY a) as window_sum FROM t1);
----
170

# Clean up
statement ok
DROP TABLE t1;

statement ok
DROP TABLE t2;

statement ok
DROP TABLE t3;

# ============================================================================
# PROTECTED columns tests (PAC metadata PROTECTED attribute)
# ============================================================================

statement ok
SET pac_conservative_mode = true;

# Create a privacy unit table (customers) and a fact table (sales) linked via PAC_LINK
statement ok
CREATE PU TABLE customers(id INTEGER PRIMARY KEY, name VARCHAR);

statement ok
INSERT INTO customers VALUES (1, 'Alice'), (2, 'Bob');

statement ok
CREATE TABLE sales(customer_id INTEGER, product_id INTEGER, amount DECIMAL(10,2), quantity INTEGER);

statement ok
INSERT INTO sales VALUES (1, 100, 50.00, 2), (1, 101, 30.00, 1), (2, 100, 75.00, 3), (2, 102, 25.00, 1);

statement ok
ALTER PU TABLE sales ADD PROTECTED (amount, quantity);

statement ok
ALTER PU TABLE sales ADD PAC_LINK (customer_id) REFERENCES customers(id);

# PAC-compatible: protected column inside SUM aggregate
query I
SELECT SUM(amount) FROM sales;
----
199.68

# Not PAC-compatible: protected column in GROUP BY
statement error
SELECT amount, COUNT(*) FROM sales GROUP BY amount;
----
PAC rewrite: protected column 'sales.amount' can only be accessed inside aggregate functions (e.g., SUM, COUNT, AVG, MIN, MAX)

# Not PAC-compatible: protected column in SELECT without aggregate
statement error
SELECT amount FROM sales;
----
PAC rewrite: protected column 'sales.amount' can only be accessed inside aggregate functions (e.g., SUM, COUNT, AVG, MIN, MAX)

# PAC-compatible: non-protected column in GROUP BY with protected column in aggregate
query II
SELECT product_id, SUM(amount) FROM sales GROUP BY product_id ORDER BY product_id;
----
100	149.76
101	0.00
102	50.00

# Not PAC-compatible: protected column projected directly (even with other aggregates)
statement error
SELECT amount, SUM(quantity) FROM sales GROUP BY amount;
----
PAC rewrite: protected column 'sales.amount' can only be accessed inside aggregate functions (e.g., SUM, COUNT, AVG, MIN, MAX)

# PAC-compatible: protected column in WHERE clause with aggregate in SELECT
query I
SELECT SUM(quantity) FROM sales WHERE amount > 30;
----
6

# Create another table for join tests
statement ok
CREATE TABLE products(product_id INTEGER PRIMARY KEY, name VARCHAR, category VARCHAR);

statement ok
INSERT INTO products VALUES (100, 'Widget', 'Hardware'), (101, 'Gadget', 'Electronics'), (102, 'Gizmo', 'Hardware');

# PAC-compatible: join with protected column only in aggregate
query II
SELECT products.category, SUM(sales.amount) FROM sales JOIN products ON sales.product_id = products.product_id GROUP BY products.category ORDER BY products.category;
----
Electronics	0.00
Hardware	199.68

# Not PAC-compatible: protected column in GROUP BY after join
statement error
SELECT sales.amount, COUNT(*) FROM sales JOIN products ON sales.product_id = products.product_id GROUP BY sales.amount;
----
PAC rewrite: protected column 'sales.amount' can only be accessed inside aggregate functions (e.g., SUM, COUNT, AVG, MIN, MAX)

# Clean up protected columns test
statement ok
DROP TABLE sales;

statement ok
DROP TABLE customers;

statement ok
DROP TABLE products;

# Test ALTER PU TABLE to add PROTECTED columns
statement ok
CREATE TABLE employees(id INTEGER, name VARCHAR, salary DECIMAL(10,2), bonus DECIMAL(10,2));

statement ok
INSERT INTO employees VALUES (1, 'Alice', 50000.00, 5000.00), (2, 'Bob', 60000.00, 6000.00), (3, 'Charlie', 55000.00, 5500.00);

# Add PROTECTED columns via ALTER PU TABLE
statement ok
ALTER PU TABLE employees ADD PROTECTED (salary);

# PAC-compatible: protected column inside aggregate
query I
SELECT SUM(salary) FROM employees;
----
165000.00

# Not PAC-compatible: protected column in GROUP BY
statement error
SELECT salary, COUNT(*) FROM employees GROUP BY salary;
----
PAC rewrite: protected column 'employees.salary' can only be accessed inside aggregate functions (e.g., SUM, COUNT, AVG, MIN, MAX)

# Non-protected column 'bonus' can still be used freely in GROUP BY
query II
SELECT bonus, COUNT(*) FROM employees GROUP BY bonus ORDER BY bonus;
----
5000.00	1
5500.00	1
6000.00	1

# Clean up
statement ok
DROP TABLE employees;

# ============================================================================
# Test cycle detection in foreign key relationships
# ============================================================================

# PAC tables cannot link to other PAC tables (cycles not supported)
# This is now detected at DDL time, not query time

# Create PU tables
statement ok
CREATE PU TABLE cycle_a (id INTEGER PRIMARY KEY, b_id INTEGER, value_a INTEGER, PROTECTED (value_a));

statement ok
CREATE PU TABLE cycle_b (id INTEGER PRIMARY KEY, c_id INTEGER, value_b INTEGER, PROTECTED (value_b));

statement ok
CREATE PU TABLE cycle_c (id INTEGER PRIMARY KEY, a_id INTEGER, value_c INTEGER, PROTECTED (value_c));

# Attempting to add PAC_LINK from PAC table to PAC table should fail
statement error
ALTER PU TABLE cycle_a ADD PAC_LINK (b_id) REFERENCES cycle_b(id);
----
Cannot create PAC LINK from PAC table 'cycle_a' to PAC table 'cycle_b'. PAC tables cannot link to other PAC tables (cycles not supported).

statement error
ALTER PU TABLE cycle_b ADD PAC_LINK (c_id) REFERENCES cycle_c(id);
----
Cannot create PAC LINK from PAC table 'cycle_b' to PAC table 'cycle_c'. PAC tables cannot link to other PAC tables (cycles not supported).

statement error
ALTER PU TABLE cycle_c ADD PAC_LINK (a_id) REFERENCES cycle_a(id);
----
Cannot create PAC LINK from PAC table 'cycle_c' to PAC table 'cycle_a'. PAC tables cannot link to other PAC tables (cycles not supported).

# Clean up cycle tables
statement ok
DROP TABLE cycle_a;

statement ok
DROP TABLE cycle_b;

statement ok
DROP TABLE cycle_c;

# ============================================================================
# Test: CREATE PU TABLE vs CREATE TABLE with PROTECTED columns
# Verifies that is_privacy_unit flag works correctly
# ============================================================================

# Test 1: CREATE PU TABLE with PROTECTED - should be a privacy unit and trigger PAC compilation
statement ok
CREATE PU TABLE pac_users (
    user_id INTEGER PRIMARY KEY,
    name VARCHAR,
    salary INTEGER,
    PAC_KEY (user_id),
    PROTECTED (salary)
);

statement ok
INSERT INTO pac_users VALUES (1, 'Alice', 50000), (2, 'Bob', 60000), (3, 'Carol', 70000);

# This should trigger PAC compilation because pac_users is a privacy unit (CREATE PU TABLE)
query I
SELECT SUM(salary) FROM pac_users;
----
259584

# Projecting non-protected columns from a PAC table should error (it's a privacy unit)
query I
SELECT name FROM pac_users;
----
Alice
Bob
Carol

# Projecting protected columns should also error
statement error
SELECT salary FROM pac_users;
----
PAC rewrite: protected column 'pac_users.salary' can only be accessed inside aggregate functions (e.g., SUM, COUNT, AVG, MIN, MAX)

# Test 2: CREATE TABLE (not PAC) with PROTECTED - should NOT be a privacy unit
# Protected columns cannot be projected, but table doesn't trigger PAC compilation
statement ok
CREATE TABLE regular_with_protected (
    id INTEGER PRIMARY KEY,
    public_data VARCHAR,
    secret_data INTEGER,
    PROTECTED (secret_data)
);

statement ok
INSERT INTO regular_with_protected VALUES (1, 'public1', 100), (2, 'public2', 200);

# Non-protected columns CAN be projected (table is not a privacy unit)
query II
SELECT id, public_data FROM regular_with_protected ORDER BY id;
----
1	public1
2	public2

# Protected columns CANNOT be projected (even though table is not a privacy unit)
statement error
SELECT secret_data FROM regular_with_protected;
----
PAC rewrite: protected column 'regular_with_protected.secret_data' can only be accessed inside aggregate functions

# Aggregating protected columns should work (no PAC compilation triggered since not a PU)
query I
SELECT SUM(secret_data) FROM regular_with_protected;
----
300

# ============================================================================
# Test: ALTER TABLE SET PU / DROP PU
# ============================================================================

# Test 3: Convert a regular table to a privacy unit using ALTER TABLE SET PU
statement ok
CREATE TABLE convertible_table (
    id INTEGER PRIMARY KEY,
    value INTEGER
);

statement ok
INSERT INTO convertible_table VALUES (1, 100), (2, 200), (3, 300);

# Before SET PU - can project columns (not a privacy unit)
query II
SELECT id, value FROM convertible_table ORDER BY id;
----
1	100
2	200
3	300

# Mark as privacy unit
statement ok
ALTER TABLE convertible_table SET PU;

# After SET PU - cannot project columns (now a privacy unit, PK is protected)
statement error
SELECT id, value FROM convertible_table;
----
PAC rewrite: protected column 'convertible_table.id' can only be accessed inside aggregate functions

# Aggregation should work with PAC compilation
query I
SELECT SUM(value) FROM convertible_table;
----
1000

# Test 4: Remove privacy unit status using ALTER TABLE UNSET PU
statement ok
ALTER TABLE convertible_table UNSET PU;

# After UNSET PU - can project columns again (no longer a privacy unit)
query II
SELECT id, value FROM convertible_table ORDER BY id;
----
1	100
2	200
3	300

# Clean up
statement ok
DROP TABLE convertible_table;

# ============================================================================
# Test: DROP TABLE metadata cleanup
# ============================================================================

# Test 5: Verify DROP TABLE cleans up PAC metadata
statement ok
CREATE PU TABLE drop_test_pu (
    id INTEGER PRIMARY KEY,
    data INTEGER,
    PAC_KEY (id),
    PROTECTED (data)
);

statement ok
CREATE TABLE drop_test_linked (
    id INTEGER,
    pu_id INTEGER,
    value INTEGER,
    PAC_LINK (pu_id) REFERENCES drop_test_pu(id)
);

statement ok
INSERT INTO drop_test_pu VALUES (1, 100), (2, 200);

statement ok
INSERT INTO drop_test_linked VALUES (1, 1, 10), (2, 2, 20);

# Verify the link works - query on linked table should trigger PAC compilation
query I
SELECT SUM(value) FROM drop_test_linked;
----
40

# Drop the privacy unit table
statement ok
DROP TABLE drop_test_pu;

# After dropping the PU, the linked table should no longer trigger PAC compilation
# (the PAC_LINK should have been cleaned up)
query III
SELECT * FROM drop_test_linked ORDER BY id;
----
1	1	10
2	2	20

# Clean up
statement ok
DROP TABLE drop_test_linked;

# Test 6: Verify DROP TABLE removes table's own metadata
statement ok
CREATE PU TABLE drop_test_self (
    id INTEGER PRIMARY KEY,
    secret INTEGER,
    PAC_KEY (id),
    PROTECTED (secret)
);

statement ok
INSERT INTO drop_test_self VALUES (1, 111), (2, 222);

# Verify it's a PAC table (cannot project - PK is protected)
statement error
SELECT * FROM drop_test_self;
----
PAC rewrite: protected column 'drop_test_self.id' can only be accessed inside aggregate functions

# Drop the table
statement ok
DROP TABLE drop_test_self;

# Recreate as regular table with same name
statement ok
CREATE TABLE drop_test_self (
    id INTEGER,
    secret INTEGER
);

statement ok
INSERT INTO drop_test_self VALUES (1, 111), (2, 222);

# Now it should work as a regular table (no PAC metadata should remain)
query II
SELECT * FROM drop_test_self ORDER BY id;
----
1	111
2	222

# Clean up
statement ok
DROP TABLE drop_test_self;

# ============================================================================
# Test: Protected columns on non-PAC tables linked to PAC tables
# ============================================================================

# Test 7: Non-PAC table with PROTECTED columns linked to PAC table
statement ok
CREATE PU TABLE test_pu_main (
    id INTEGER PRIMARY KEY,
    name VARCHAR,
    PAC_KEY (id)
);

statement ok
CREATE TABLE test_linked_protected (
    id INTEGER,
    pu_id INTEGER,
    public_val INTEGER,
    secret_val INTEGER,
    PAC_LINK (pu_id) REFERENCES test_pu_main(id),
    PROTECTED (secret_val)
);

statement ok
INSERT INTO test_pu_main VALUES (1, 'A'), (2, 'B');

statement ok
INSERT INTO test_linked_protected VALUES (1, 1, 10, 100), (2, 2, 20, 200);

# Query on linked table triggers PAC compilation (due to link to PU)
# Non-protected columns can be aggregated
query I
SELECT SUM(public_val) FROM test_linked_protected;
----
40

# But protected columns cannot be projected
statement error
SELECT secret_val FROM test_linked_protected;
----
PAC rewrite: protected column 'test_linked_protected.secret_val' can only be accessed inside aggregate functions

# Clean up
statement ok
DROP TABLE test_linked_protected;

statement ok
DROP TABLE test_pu_main;

# Clean up tables from earlier tests
statement ok
DROP TABLE pac_users;

statement ok
DROP TABLE regular_with_protected;

